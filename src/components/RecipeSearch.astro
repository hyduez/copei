---
import { Icon } from 'astro-icon/components';
import { getCollection, type CollectionEntry } from 'astro:content';
import { allCategories } from '../consts';
import RecipeCard from './RecipeCard.astro';

const articles: CollectionEntry<'articles'>[] = (
  await getCollection('articles')
)
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf())
  .filter((x) => allCategories.includes(x.data.category ?? ''));

const allTags = Array.from(new Set(articles.flatMap((r) => r.data.tags)));

const firstArticle = articles[0];
---

<section class="py-20 min-h-screen" id="recipe-search-section">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="text-center mb-12">
      <div class="inline-flex items-center gap-2 bg-green-100 text-green-700 px-4 py-2 rounded-full mb-4">
        <Icon name="mdi:chef-hat" class="w-4 h-4" />
        <span class="text-sm">Recipe Database</span>
      </div>
      <h1 class="text-5xl mb-4">Find Your Perfect Healthy Recipe</h1>
      <p class="text-xl text-gray-600 max-w-2xl mx-auto">
        Search through our collection of delicious, nutritious recipes that actually taste good
      </p>
    </div>

    <div class="flex flex-wrap gap-3 justify-center mb-12" id="filter-categories">
      <button
        data-category="all" class="px-4 py-2 rounded-full text-sm transition-all bg-green-600 text-white shadow-lg"
      >
        All Categories
      </button>
      {allCategories.map(tag => (
        <button
          data-category={tag} class="px-4 py-2 rounded-full text-sm transition-all capitalize bg-white text-gray-600 border border-gray-200 hover:border-green-600"
        >
          {tag}
        </button>
      ))}
    </div>

    <div class="max-w-2xl mx-auto mb-8">
      <div class="relative">
        <Icon name="mdi:search" class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" />
        <input
          type="text"
          placeholder="Search recipes by name or ingredient..."
          id="search-input"
          data-search
          class="w-full pl-12 pr-4 py-4 rounded-full border-2 border-gray-200 focus:border-green-500 focus:outline-none text-lg"
        />
      </div>
    </div>

    <div class="flex flex-wrap gap-3 justify-center mb-12" id="filter-tags">
      <button
        data-tag="all"
        class="px-4 py-2 rounded-full text-sm transition-all bg-green-600 text-white shadow-lg"
      >
        All Tags
      </button>
      {allTags.map(tag => (
        <button
          data-tag={tag}
          class="px-4 py-2 rounded-full text-sm transition-all capitalize bg-white text-gray-600 border border-gray-200 hover:border-green-600"
        >
          {tag}
        </button>
      ))}
    </div>

    <div class="text-center mb-8">
      <p class="text-gray-600">
        Found <span class="text-green-600" id="results-count">{articles.length}</span> delicious recipes
      </p>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="recipe-grid">
      {articles.map(article => (
        <RecipeCard article={article} />
      ))}
    </div>

    <div class="text-center py-20 hidden" id="no-results">
      <div class="text-6xl mb-4">üîç</div>
      <h3 class="text-2xl mb-2">No recipes found</h3>
      <p class="text-gray-600">Try adjusting your search or filters</p>
    </div>

    {firstArticle && (
      <template id="recipe-card-template">
        <RecipeCard article={firstArticle} />
      </template>
    )}

  </div>
</section>

<script define:vars={{ articles: articles }}>

  const searchInput = document.getElementById('search-input');
  const tagContainer = document.getElementById('filter-tags');
  const categoryContainer = document.getElementById('filter-categories');
  const recipeGrid = document.getElementById('recipe-grid');
  const resultsCountSpan = document.getElementById('results-count');
  const noResultsDiv = document.getElementById('no-results');
  const templateElement = document.getElementById('recipe-card-template');
  
  const allArticles = articles.map(article => ({
      ...article,
      searchContent: (article.data.title + ' ' + (article.data.description || '')).toLowerCase(),
      tags: article.data.tags || [],
      category: article.data.category || '',
      calories: article.data.calories,
      time: article.data.time,
      servings: article.data.servings,
      image: article.data.image,
  }));
  
  const rawCardHTML = templateElement ? templateElement.innerHTML : null;

  let currentSearchQuery = '';
  let currentSelectedCategory = 'all';
  let currentSelectedTag = 'all';
  
  const getCategoryStyle = (category) => {
    switch (category) {
        case 'Healthy':
            return 'bg-green-100 text-green-700 border-green-200';
        case 'Junk':
            return 'bg-orange-100 text-orange-700 border-orange-200';
        default:
            return 'bg-purple-100 text-purple-700 border-purple-200';
    }
  };

  const getCategoryLabel = (category) => {
    switch (category) {
        case 'Healthy':
            return 'ü•ó Healthy';
        case 'Junk':
            return 'üçî Junk';
        default:
            return '‚öñÔ∏è Both';
    }
  };

  function createCardNode(article) {
    if (!rawCardHTML) return null;
    
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = rawCardHTML.trim();

    const cardWrapper = tempDiv.firstChild; 
    const card = cardWrapper.querySelector('article');

    if (!card) return null;

    card.dataset.recipeId = article.id;
    card.dataset.recipeTags = article.tags.join(',') || '';
    card.dataset.recipeCategory = article.category;
    card.dataset.recipeSearch = article.searchContent;
    
    cardWrapper.href = `/articles/${article.id}`;
    
    card.querySelector('h3').textContent = article.data.title;
    card.querySelector('p.text-gray-600').textContent = article.data.description;

    const metadataContainer = card.querySelector('.flex.items-center.text-xs.text-gray-500.gap-3');

    const caloriesHTML = article.calories ? `
      <div class="px-2 py-0.5 rounded-full text-xs border border-red-200 bg-red-100 text-red-700 flex items-center gap-1">
        <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="currentColor" d="M17.66 11.2c-.23-.3-.51-.56-.77-.82c-.67-.6-1.43-1.03-2.07-1.66C13.33 7.26 13 4.85 13.95 3c-.95.23-1.78.75-2.49 1.32c-2.59 2.08-3.61 5.75-2.39 8.9c.04.1.08.2.08.33c0 .22-.15.42-.35.5c-.23.1-.47.04-.66-.12a.6.6 0 0 1-.14-.17c-1.13-1.43-1.31-3.48-.55-5.12C5.78 10 4.87 12.3 5 14.47c.06.5.12 1 .29 1.5c.14.6.41 1.2.71 1.73c1.08 1.73 2.95 2.97 4.96 3.22c2.14.27 4.43-.12 6.07-1.6c1.83-1.66 2.47-4.32 1.53-6.6l-.13-.26c-.21-.46-.77-1.26-.77-1.26m-3.16 6.3c-.28.24-.74.5-1.1.6c-1.12.4-2.24-.16-2.9-.82c1.19-.28 1.9-1.16 2.11-2.05c.17-.8-.15-1.46-.28-2.23c-.12-.74-.1-1.37.17-2.06c.19.38.39.76.63 1.06c.77 1 1.98 1.44 2.24 2.8c.04.14.06.28.06.43c.03.82-.33 1.72-.93 2.27"/>
          </svg>
        <span>${article.calories} Kcal</span>
      </div>
    ` : '';
    
    if (metadataContainer) {
        metadataContainer.innerHTML = `
            <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="currentColor" d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8s-8 3.58-8 8s3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13l.75 1.3z"/></svg>
            <span>${article.time || 'N/A'}</span>
            <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="currentColor" d="M16 17v2H2v-2s0-4 7-4s7 4 7 4m-3.5-9.5A3.5 3.5 0 1 0 9 11a3.5 3.5 0 0 0 3.5-3.5m3.44 5.5A5.32 5.32 0 0 1 18 17v2h4v-2s0-3.63-6.06-4M15 4a3.4 3.4 0 0 0-1.93.59a5 5 0 0 1 0 5.82A3.4 3.4 0 0 0 15 11a3.5 3.5 0 0 0 0-7"/></svg>
            <span>${article.servings || 'N/A'} Servings</span>
            ${caloriesHTML}
        `;
    }

    const tagsContainer = card.querySelector('.flex.flex-wrap.gap-1');
    tagsContainer.innerHTML = article.tags.map(tag => 
        `<span class="text-xs bg-gray-100 text-gray-700 px-2 py-0.5 rounded-full capitalize">${tag}</span>`
    ).join('') || '';

    const categorySpan = card.querySelector('.absolute.top-4.left-4 span');
    if (categorySpan) {
        const categoryStyle = getCategoryStyle(article.category);
        const categoryLabel = getCategoryLabel(article.category);
        categorySpan.className = `px-3 py-1 rounded-full text-xs border ${categoryStyle}`;
        categorySpan.textContent = categoryLabel;
    }

    const imgElement = card.querySelector('img');
    if (article.image && imgElement) {
      if (article.image.src) {
        imgElement.src = article.image.src;
      } else {
        imgElement.src = article.image;
      }
    }

    return cardWrapper;
  }

  function updateURL(search, tag, category) {
      const url = new URL(window.location);
      if (search) {
          url.searchParams.set('q', search);
      } else {
          url.searchParams.delete('q');
      }
      if (tag && tag !== 'all') {
          url.searchParams.set('tag', tag);
      } else {
          url.searchParams.delete('tag');
      }
      if (category && category !== 'all') {
          url.searchParams.set('category', category);
      } else {
          url.searchParams.delete('category');
      }
      window.history.pushState({}, '', url);
  }

  function renderRecipes() {
    const filteredArticles = allArticles.filter(article => {
        const matchesSearch = currentSearchQuery.length === 0 || article.searchContent.includes(currentSearchQuery.toLowerCase());
        const matchesTag = currentSelectedTag === 'all' || article.tags.includes(currentSelectedTag);
        const matchesCategory = currentSelectedCategory === 'all' || article.category === currentSelectedCategory; 

        return matchesSearch && matchesTag && matchesCategory;
    });
    
    const fragment = document.createDocumentFragment();

    filteredArticles.forEach(article => {
        const cardNode = createCardNode(article);
        if (cardNode) {
            fragment.appendChild(cardNode);
        }
    });

    recipeGrid.innerHTML = '';
    recipeGrid.appendChild(fragment);

    resultsCountSpan.textContent = filteredArticles.length;
    noResultsDiv.style.display = filteredArticles.length === 0 ? 'block' : 'none';
  }
  
  function updateButtonStyles(container, currentSelection, dataAttribute) {
    container.querySelectorAll('button').forEach(btn => {
      const value = btn.dataset[dataAttribute];
      let classes = 'px-4 py-2 rounded-full text-sm transition-all capitalize ';

      if (value === currentSelection) {
        classes += 'bg-green-600 text-white shadow-lg';
      } else {
        classes += 'bg-white text-gray-600 border border-gray-200 hover:border-green-600';
      }
      btn.className = classes;
    });
  }
  
  function handleFilterChange(type, value) {
      if (type === 'tag') {
          currentSelectedTag = value;
          updateButtonStyles(tagContainer, currentSelectedTag, 'tag');
      } else if (type === 'category') {
          currentSelectedCategory = value; 
          updateButtonStyles(categoryContainer, currentSelectedCategory, 'category');
      } else if (type === 'search') {
          currentSearchQuery = value;
      }

      renderRecipes();
      updateURL(currentSearchQuery, currentSelectedTag, currentSelectedCategory);
  }

  searchInput.addEventListener('input', (e) => {
    handleFilterChange('search', e.target.value);
  });

  tagContainer.addEventListener('click', (e) => {
    const button = e.target.closest('button');
    if (button && button.dataset.tag) {
      handleFilterChange('tag', button.dataset.tag);
    }
  });

  categoryContainer.addEventListener('click', (e) => {
    const button = e.target.closest('button');
    if (button && button.dataset.category) {
      handleFilterChange('category', button.dataset.category);
    }
  });

  function initializeFromURL() {
      const urlParams = new URLSearchParams(window.location.search);
      const q = urlParams.get('q');
      const tag = urlParams.get('tag');
      const category = urlParams.get('category');

      if (q) {
          currentSearchQuery = q.toLowerCase();
          searchInput.value = q;
      }
      if (tag) {
          currentSelectedTag = tag;
      }
      if (category) {
          currentSelectedCategory = category;
      }
      
      updateButtonStyles(categoryContainer, currentSelectedCategory, 'category');
      updateButtonStyles(tagContainer, currentSelectedTag, 'tag');
      renderRecipes(); 
  }

  document.addEventListener('DOMContentLoaded', initializeFromURL);
</script>